# UnType (忘言)

> 筌者所以在鱼，得鱼而忘筌；蹄者所以在兔，得兔而忘蹄；言者所以在意，得意而忘言。
> — 《庄子·外物》

[English](README_EN.md)

**UnType** 是一个开源的 AI 语音输入工具（Windows）。它不只是转录——它会**思考**。一个快捷键，两种超能力：

1. **说话即输入** — 语音经 STT 转录后，LLM 自动润色：去除语气词（"嗯"、"那个"）、修正标点、纠正识别错误。到达光标的是润色后的成稿，不是原始语音垃圾。

2. **选中即润色** — 选中已有文字，说出修改指令（"缩短一些"、"翻译成英文"、"改成更正式的语气"），LLM 帮你改写。语音驱动的文字编辑，随处可用。

## 为什么选 UnType？

大多数语音输入工具只给你原始转录——充满"嗯"、"那个"、标点错误和识别偏差。你最终花在修正上的时间，比省下的打字时间还多。

**UnType = STT + LLM。** 语音先转录，再由 LLM 润色为干净、规范的文本——开口即终稿。需要编辑已有文字时，选中它，说话就行。

## 功能

- **AI 润色输出** — 不是原始转录。LLM 在文本到达光标前，自动修正标点、语气词、语法和识别错误。
- **语音编辑选中文字** — 选中文字，说出指令，LLM 执行修改。语音版的超级查找替换。
- **按键说话** — 按一下快捷键（默认 F6）开始录音，再按一下结束。也可切换为按住模式。在任何应用中都能用。
- **音量可视化** — 录音时胶囊底部显示音量条，实时反馈麦克风状态。
- **三语音识别后端** — 在线 API（OpenAI 兼容）、本地推理（[faster-whisper](https://github.com/SYSTRAN/faster-whisper)）或阿里云实时 API。自由选择。
- **实时转录预览** — 使用阿里云实时 API 时，录音过程中即可看到识别文字，体验类似微信语音输入。
- **系统托盘界面** — 带颜色状态指示的托盘图标 + 设置对话框。
- **快捷键录制** — 在设置中点击输入框后按下想要的键，即可自定义快捷键。
- **人格面具** — 录音时按数字键（1-9）或点击即可预选 LLM 人格。为不同场景定义语气配置：学术、职场、日常、要点整理——每个都有独立的提示词、模型和温度。往 `personas/` 目录放一个 JSON 文件就能新增人格。预选人格后跳过暂存区，工作流更快。
- **后悔药** — 注入后出现撤销菜单，支持恢复原文、重新生成或撤回编辑。没有倒计时压力。
- **胶囊位置可调** — 固定模式（可拖动，位置会被记住）或跟随光标模式。

## 工作原理

```
按一下快捷键 → 说话 → 再按一下结束
                ↓
   （录音期间：人格栏可见，
    按 1-9 预选人格）
                ↓
        [ STT：语音 → 原始文本 ]
                ↓
   ┌─── 已配置人格？ ───┐
   │ 是                  │ 否
   ↓                     ↓
[ LLM：使用人格 ]   [ 暂存区：编辑 ]
   ↓                     ↓
文本出现在光标处 ✓  [ LLM → 光标 ✓ ]
                ↓
       （后悔药菜单出现）
```

**两种模式，自动检测：**

| 模式 | 触发条件 | 效果 |
|------|---------|------|
| **插入** | 未选中文本 | 语音 → STT → LLM 润色 → 插入光标处 |
| **润色** | 已选中文本 | 语音作为指令 → LLM 修改选中的文本 |

## 快速开始

```bash
git clone https://github.com/jlmaoju/untype.git
cd untype
uv sync
uv run untype
```

1. 系统托盘出现绿色圆点。右键 → **Settings** → 填入 API 密钥。
2. 在任意输入框中点击，按一下 **F6** 开始录音，说话，再按一下 **F6** 结束。
3. 润色好的文字出现在光标处。

## 环境要求

- Windows 10/11
- Python 3.11+
- [uv](https://docs.astral.sh/uv/)（推荐的包管理器）
- 可用的麦克风
- OpenAI 兼容的 STT API 密钥（在线模式），或 GPU（本地 Whisper 推理）
- OpenAI 兼容的 LLM API 密钥（用于文本润色；可选但推荐）

## 配置

设置存储在 `~/.untype/config.toml`（首次启动时创建）：

| 区段 | 键 | 默认值 | 说明 |
|------|-----|--------|------|
| `hotkey` | `trigger` | `f6` | 按键说话快捷键 |
| `hotkey` | `mode` | `toggle` | `toggle`（按一下开始/结束）或 `hold`（按住说话） |
| `overlay` | `capsule_position_mode` | `"fixed"` | 胶囊位置模式：`"fixed"`（可拖动）或 `"caret"`（跟随光标） |
| `overlay` | `capsule_fixed_x` | `null` | 固定模式的 X 坐标（null = 自动居中） |
| `overlay` | `capsule_fixed_y` | `null` | 固定模式的 Y 坐标（null = 自动底部） |
| `audio` | `gain_boost` | `3.0` | 低音量语音增益倍数 |
| `stt` | `backend` | `api` | `api`、`local` 或 `realtime_api` |
| `stt` | `api_base_url` | `""` | OpenAI 兼容 STT API 端点 |
| `stt` | `api_key` | `""` | STT API 密钥 |
| `stt` | `api_model` | `gpt-4o-transcribe` | STT 模型名称 |
| `stt` | `realtime_api_key` | `""` | 阿里云实时 STT API 密钥（留空则使用 api_key） |
| `stt` | `realtime_api_model` | `paraformer-realtime-v2` | 阿里云实时 STT 模型 |
| `stt` | `model_size` | `small` | 本地 Whisper 模型大小 |
| `llm` | `base_url` | `""` | OpenAI 兼容 Chat API 端点 |
| `llm` | `api_key` | `""` | LLM API 密钥 |
| `llm` | `model` | `""` | LLM 模型名称 |

### STT 后端选择

**在线 API（默认）**
- 使用 OpenAI 兼容的 `/audio/transcriptions` 接口
- 支持任意中转服务
- 录音结束后一次性返回结果

**本地模型**
- 使用 [faster-whisper](https://github.com/SYSTRAN/faster-whisper) 本地推理
- 需要显卡支持（CUDA）
- 隐私性好，无需联网

**阿里云实时 API（新增）**
- 使用阿里云 DashScope 实时语音识别
- **采用 WebSocket 流式传输，录音过程中实时显示识别文字**
- **延迟极低，体验接近微信语音输入**
- 需要申请 [阿里云 DashScope API Key](https://dashscope.console.aliyun.com/)

### 人格面具

人格面具让 AI 以不同的「角色」处理你的语音。录音时按数字键（1-9）或点击即可预选人格，跳过暂存区直达 LLM。

**内置人格：**

| 图标 | 名称 | 用途 |
|------|------|------|
| 👔 | 对领导 | 正式、得体的职场沟通 |
| 🤝 | 对同事 | 友好但专业的日常交流 |
| 📋 | 子弹点 | 自动整理成要点列表 |
| 🌐 | 英译 | 中文语音 → 英文输出 |
| 🗣️ | 大白话 | 把复杂概念说简单 |
| 🙅 | 婉拒 | 礼貌地拒绝各种请求 |

**管理方式：**

右键托盘图标 → **人格管理...** 打开图形界面，支持：
- 新建、编辑、删除人格
- 导入/导出 JSON 文件（方便分享）
- 打开人格目录直接管理文件

每个人格可自定义：
- 插入模式的提示词
- 润色模式的提示词
- 独立的模型、温度、最大令牌数

## 开发

```bash
uv run ruff check src/      # 代码检查
uv run ruff format src/      # 代码格式化
uv run pytest                # 运行测试
```

## 许可证

本项目采用 [GNU 通用公共许可证 v3.0](LICENSE) 授权。

## 更新日志

### v0.2.0 (2025-02-25)
- 新增阿里云实时语音识别后端，录音过程中实时显示识别文字
- 新增胶囊位置固定模式（可拖动，位置会被记住）
- 新增设置界面字段动态显示（根据后端选择显示/隐藏相关配置）
- 修复快捷键切换时的竞态条件问题
- 修复快捷键黑名单（防止与系统快捷键冲突）
- 修复后悔菜单位置跟随胶囊配置
